---
title: "Home"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: false
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
library(tidyverse)
library(lubridate)
library(scales)
library(TTR)
library(glue)
library(patchwork)
library(ckanr) # library to interact with CA Gov. Public Health Portal

# connect to CKAN instance
ckanr_setup(url="https://data.ca.gov")
ckan <- ckanr::src_ckan("https://data.ca.gov")

# get resources
resources <- rbind(resource_search("name:covid-19", as = "table")$results,
             resource_search("name:hospitals by county", as = "table")$results)

resource_ids <- list(cases = resources$resource_id[resources$name == "COVID-19 Cases"],
                     tests = resources$resource_id[resources$name == "COVID-19 Testing"],
                     hosp = resources$resource_id[resources$name == "Hospitals By County"])

# pull resources into data frames (adds extra cols _id and _full_text)
cases <- tbl(src = ckan$con, from = resource_ids$cases) %>%
  as_tibble( )%>%
  select(-starts_with("_")) %>% 
  mutate(date = as.Date(date))

tests <- tbl(src = ckan$con, from = resource_ids$test) %>%
  as_tibble() %>%
  select(-starts_with("_")) %>% 
  mutate(date = as.Date(date))

hosp <- tbl(src = ckan$con, from = resource_ids$hosp) %>%
  as_tibble() %>%
  select(-starts_with("_")) %>% 
  mutate(date = as.Date(todays_date)) %>% 
  select(-todays_date)

county_pop <- read_csv("data/county_pop.csv") %>% rename_all(str_to_lower)

sah_start <- ymd("2020-03-19")
sah_end <- ymd("2020-05-04")
```



```{r tidy data, message=FALSE}
# Data Processing Options
counties_of_interest <- c("San Diego",  "Los Angeles",  "Orange", "Alameda", "Santa Clara")

per_n_people <- 1e6
ma_n <- 7

# Tidy Data
hosp_tidy <- hosp %>%
  filter(county %in% counties_of_interest) %>% 
  pivot_longer(cols = -c(date, county)) %>% 
  drop_na() %>% 
  left_join(county_pop) %>% 
  arrange(county, date)

cases_tidy <- cases %>% 
  filter(county %in% counties_of_interest) %>% 
  pivot_longer(cols = -c(date, county)) %>% 
  drop_na() %>% 
  left_join(county_pop) %>% 
  arrange(county, date)

# Theme Options
theme_set(theme_bw() +
            theme(legend.position = "bottom",
                  text = element_text(size=14)))

update_geom_defaults("line", list(size = 1.5))

cbPalette <- c("#56B4E9", "#009E73", "#E69F00", "#CC79A7", "#0072B2")
sah_alpha <- 0.2

gglayers = list(
  geom_line(),
  scale_color_manual(name = "County", values = cbPalette),
  scale_x_date(name = "Date",
               breaks = "14 day",
               date_labels = "%b %d"),
  scale_y_continuous(name = NULL,
                     label = comma)
)
```

```{r make plots}
# ICU Occupancy
icu_plot_data <- hosp_tidy %>% 
  filter(name %in% c("icu_covid_confirmed_patients", "icu_suspected_covid_patients")) %>% 
  group_by(county, date, population) %>% 
  summarize(value = sum(value)) %>% 
  group_by(county) %>%
  mutate(value = runMean(value, ma_n)) %>%
  drop_na()

icu_plot <- icu_plot_data %>% 
  ggplot(aes(date, value / population * per_n_people, group = county, color = county)) +
  ggtitle(glue("ICU Patients with COVID-19 per {comma(per_n_people)} People"),
          subtitle = glue("{ma_n} Day Moving Average")) +
 gglayers +
  annotate("rect",
           xmin = if_else(min(icu_plot_data$date) < sah_start,
                          sah_start,
                          min(icu_plot_data$date)),
           xmax = sah_end, ymin = -Inf, ymax = Inf, alpha = sah_alpha) +
    annotate("text", y = 55, x = sah_end, label = "Stay at Home\n Order Ended")

# Hospitalizations
hospitalizations_plot_data <- hosp_tidy %>% 
  filter(name == "hospitalized_covid_patients") %>% 
  group_by(county) %>%
  mutate(value = runMean(value, ma_n)) %>% 
  drop_na()

hospitalizations_plot <- hospitalizations_plot_data %>% 
  ggplot(aes(date, value / population * per_n_people, group = county, color = county)) +
  ggtitle(glue("Hospitalized Patients with COVID-19 per {comma(per_n_people)} People"),
          subtitle = glue("{ma_n} Day Moving Average")) +
  gglayers +
  annotate("rect",
           xmin = if_else(min(hospitalizations_plot_data$date) < sah_start,
                          sah_start,
                          min(hospitalizations_plot_data$date)),
           xmax = sah_end, ymin = -Inf, ymax = Inf, alpha = sah_alpha) +
    annotate("text", y = 175, x = sah_end, label = "Stay at Home\n Order Ended")

# Deaths
deaths_plot_data <- cases_tidy %>% 
  filter(name == "newcountdeaths") %>% 
  group_by(county) %>%
  mutate(value = runMean(value, ma_n)) %>% 
  drop_na()

deaths_plot <- deaths_plot_data %>% 
  ggplot(aes(date, value / population * per_n_people, group = county, color = county)) +
  ggtitle(glue("Daily Deaths due to COVID-19 per {comma(per_n_people)} People"),
          subtitle = glue("{ma_n} Day Moving Average")) +
  gglayers +
  annotate("rect",
           xmin = if_else(min(deaths_plot_data$date) < sah_start,
                          sah_start,
                          min(deaths_plot_data$date)),
           xmax = sah_end, ymin = -Inf, ymax = Inf, alpha = sah_alpha) +
    annotate("text", y = 3, x = sah_end, label = "Stay at Home\n Order Ended")

# Cases
cases_plot_data <- cases_tidy %>% 
  filter(name == "newcountconfirmed") %>% 
  group_by(county) %>%
  mutate(value = runMean(value, ma_n)) %>% 
  drop_na()

cases_plot <- cases_plot_data %>% 
  ggplot(aes(date, value / population * per_n_people, group = county, color = county)) +
  ggtitle(glue("Daily Confirmed COVID-19 Cases per {comma(per_n_people)} People"),
          subtitle = glue("{ma_n} Day Moving Average")) +
  gglayers +
    annotate("rect",
           xmin = if_else(min(cases_plot_data$date) < sah_start,
                          sah_start,
                          min(cases_plot_data$date)),
           xmax = sah_end, ymin = -Inf, ymax = Inf, alpha = sah_alpha) +
  annotate("text", y = 250, x = sah_end, label = "Stay at Home\n Order Ended")
```


```{r plot}
hospitalizations_plot
icu_plot
deaths_plot
cases_plot
```

Data collected from the [California Open Data Portal](https://data.ca.gov/group/covid-19).

Last updated `r as.Date(max(resources$last_modified[resources$name %in% c("COVID-19 Cases", "COVID-19 Testing", "Hospitals By County")]))`.
